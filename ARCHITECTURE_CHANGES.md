# Архитектурные изменения - Двухфазное рукопожатие

## Обзор
Реализована новая архитектура с четким разделением на две фазы:
1. **Фаза 1: Сигналинг** - WebSocket соединение, идентификация пиров
2. **Фаза 2: Медиа** - WebRTC соединение, обмен медиа-потоками

## Новые файлы

### `web/signaling-session.js`
- **SignalingSession** класс для управления WebSocket
- Автоматические ретраи и refresh токенов
- Управление peer идентификацией и politeness
- Логирование с префиксом `[signal]`

### `web/media-session.js`  
- **MediaSession** класс с состояниями: `idle → preparing → active`
- Управление RTCPeerConnection и медиа-треками
- Автоматическое восстановление треков с таймаутами
- Логирование с префиксом `[media]`

## Изменения в `web/client.js`
- Удалена старая монолитная логика
- Интеграция с новыми классами
- Обновлены обработчики кнопок и UI
- Улучшенное логирование

## Изменения в `web/index.html`
- Подключены новые JS модули
- Сохранена обратная совместимость

## Ключевые улучшения

### 1. Стабильность соединения
- Сигналинг переживает смену сети
- Медиа-фаза перезапускается независимо
- Автоматическое восстановление при сбоях

### 2. Улучшенная диагностика
- Четкие префиксы: `[signal]`, `[media]`, `[recover]`
- Состояния машин: `idle`, `preparing`, `active`
- Детальное логирование всех операций

### 3. Автоматизация
- Нет ручных "разрешите доступ"
- Автоматическое восстановление треков
- Умные retry с таймаутами

### 4. UX улучшения
- Пользователь может "присутствовать" без камеры/микрофона
- Медиа подключается автоматически при получении разрешений
- Информативные сообщения в UI

## Логирование

### Сигналинг (`[signal]`)
- `join ok` - успешное подключение
- `ws open/close` - состояние WebSocket
- `peers` - список участников
- `retry` - попытки переподключения

### Медиа (`[media]`)
- `state change` - переходы состояний
- `preparing local media` - подготовка медиа
- `track ended/recovered` - события треков
- `stats` - статистика RTP

### Восстановление (`[recover]`)
- `recover start/exit` - начало/конец восстановления
- `replaceTrack attempt/success` - замена треков
- `TIMEOUT` - таймауты getUserMedia

## Тестирование
Рекомендуется протестировать:
1. Подключение с/без камеры/микрофона
2. Отключение/включение устройств во время звонка
3. Смена сети (WiFi ↔ мобильный)
4. Обновление страницы
5. Попытки третьего участника (room-full)

## Обратная совместимость
- API endpoints остались без изменений
- JWT токены работают как прежде
- Существующие звонки продолжают работать
