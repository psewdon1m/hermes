# Использование API Hermes

В этом документе перечислены публичные HTTP-эндпоинты сервиса Hermes API и правила их вызова. Все маршруты имеют общий базовый URL, задаваемый переменной окружения `CALL_API_BASE` на стороне клиента (по умолчанию `https://example.com`).

## Общие требования

- Запросы и ответы используют JSON.
- Клиенты должны отправлять заголовок `Content-Type: application/json` для всех `POST`-запросов.
- Действует глобальный лимит частоты (60 запросов в минуту на IP); обрабатывайте ответы `429` с экспоненциальным бэкоффом.
- `/api/call/resolve` дополнительно защищен анти-брутфорс лимитером (40 попыток на IP и 25 на хэш кода в течение 5 минут).
- OTC (одноразовые коды), выдаваемые `/api/call/create`, истекают через 15 минут; join-токены и join-коды действуют `JOIN_TOKEN_TTL_SECONDS` (по умолчанию 24 часа).

### Join tokens vs. join codes

- `joinToken`: HS256 JWT, выдаваемый API и используемый как эндпоинтом `/api/join`, так и сигнальным сервером. Пейлоад содержит `callId`, `role` и `exp`.
- `joinCode`: 16-символьная base64url-строка, сопоставленная с `joinToken`, который хранится в Redis. Коды можно безопасно встраивать в URL (`/join?code=...`), срок действия соответствует связанному токену.
- `/api/join` принимает любой из них: передавайте `token` для прямого доступа (например, ботами) или `code` для коротких ссылок, создаваемых лендингом и Telegram-ботом.

## `POST /api/call/create`

Создает новую сессию звонка и возвращает данные, необходимые инициатору.

- **Тело запроса**

  ```json
  {
    "initiator_telegram_id": "123456789"
  }
  ```

  | Поле | Тип | Описание |
  |------|-----|----------|
  | `initiator_telegram_id` | string | Telegram ID инициатора (1-64 символа). |

- **Успешный ответ (`200`)**

  ```json
  {
    "callId": "c_ab12cd34ef56",
    "code": "A1B2C3",
    "joinUrl": "https://example.com/join?code=Z8sK1L0PqR4TuWxy",
    "joinCode": "Z8sK1L0PqR4TuWxy",
    "joinToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```

  | Поле | Тип | Описание |
  |------|-----|----------|
  | `callId` | string | Внутренний идентификатор звонка (префикс `c_`, 16 hex-символов). |
  | `code` | string | 6-символьный буквенно-цифровой код (верхний регистр), действует 15 минут. |
  | `joinUrl` | string | Короткая ссылка (`/join?code=...`) с кодом, который отображается на JWT на сервере. |
  | `joinCode` | string | 16-символьный base64url-код, связанный с join-токеном. |
  | `joinToken` | string | Полный JWT (HS256) для прямого использования API; дублирует `joinCode`. |

- **Ошибки**

  | Статус | Тело | Значение |
  |--------|------|----------|
  | `400` | `{"error":"bad_request","details":[...]}` | Валидация payload не пройдена. |
  | `429` | `{"error":"too_many_requests"}` | Превышен лимит запросов. |
  | `500` | `{"error":"internal_error"}` | Неожиданная ошибка сервера. |

## `POST /api/call/resolve`

Обменивает ранее выданный код звонка на join-ссылку для отвечающего участника.

- **Тело запроса**

  ```json
  {
    "code": "A1B2C3"
  }
  ```

  | Поле | Тип | Описание |
  |------|-----|----------|
  | `code` | string | 6-символьный буквенно-цифровой код (регистр не важен). |

- **Успешный ответ (`200`)**

  ```json
  {
    "joinUrl": "https://example.com/join?code=Z8sK1L0PqR4TuWxy",
    "joinCode": "Z8sK1L0PqR4TuWxy",
    "joinToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```

  | Поле | Тип | Описание |
  |------|-----|----------|
  | `joinUrl` | string | Короткая ссылка для участника (16-символьный код в URL). |
  | `joinCode` | string | 16-символьный base64url-код, связанный с join-токеном. |
  | `joinToken` | string | Полный JWT (TTL 24 часа по умолчанию) для прямого доступа к API. |

  JWT выдает роль `answerer`.

- **Ошибки**

  | Статус | Тело | Значение |
  |--------|------|----------|
  | `400` | `{"error":"bad_request","details":[...]}` | Валидация payload не пройдена. |
  | `404` | `{"error":"code_not_found_or_expired"}` | Код истек (15 минут) или не существовал. |
  | `429` | `{"error":"too_many_requests"}` | Превышен лимит запросов. |
  | `500` | `{"error":"internal_error"}` | Неожиданная ошибка сервера. |

## `POST /api/join`

Обменивает join-токен (JWT) или короткий код на параметры подключения, используемые WebRTC-клиентом.

- **Тело запроса**

  ```json
  {
    "code": "Z8sK1L0PqR4TuWxy"
  }
  ```

  | Поле | Тип | Описание |
  |------|-----|----------|
  | `token` | string | Join-токен (JWT), полученный из `joinUrl`. Минимальная длина 10 символов. |
  | `code` | string | Короткий код из join-ссылки (12-32 base64url-символа). Нужно передать `token` или `code`. |

  Пример прямого использования токена:

  ```json
  {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```

- **Успешный ответ (`200`)**

  ```json
  {
    "callId": "c_ab12cd34ef56",
    "role": "offerer",
    "iceServers": [
      { "urls": ["stun:example.com:3478"] },
      {
        "urls": ["turn:example.com:3478?transport=udp"],
        "username": "1730227200:user",
        "credential": "base64-hmac"
      },
      {
        "urls": ["turns:example.com:5349?transport=tcp"],
        "username": "1730227200:user",
        "credential": "base64-hmac"
      }
    ],
    "wsUrl": "wss://example.com/ws",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
  ```

  | Поле | Тип | Описание |
  |------|-----|----------|
  | `callId` | string | Идентификатор звонка, привязанный к токену. |
  | `role` | string | `offerer` или `answerer` в зависимости от порядка подключения (первый участник становится `offerer`). |
  | `iceServers` | array | Учетные данные STUN/TURN, действительные 10 минут и вычисленные из `TURN_DOMAIN`/`TURN_SECRET`. |
  | `wsUrl` | string | WebSocket-эндпоинт сигналинга (`WS_PUBLIC`). |
  | `token` | string | Join-токен, возвращенный сервером (соответствует использованному JWT). |

- **Ошибки**

  | Статус | Тело | Значение |
  |--------|------|----------|
  | `400` | `{"error":"bad_request","details":[...]}` | Валидация payload не пройдена. |
  | `401` | `{"error":"bad_jwt" \| "bad_jwt_sig" \| "jwt_expired" \| "bad_jwt_payload" \| "bad_join_code"}` | Токен/код недействителен или истек. |
  | `500` | `{"error":"internal_error"}` | Неожиданная ошибка сервера. |

## Health-пробы

- `GET /healthz` - общий liveness-проб на корневом хосте.
- `GET /api/healthz` - probe через Caddy, когда наружу отдается только `/api/*`.

Простой эндпоинт для проверки здоровья.

- **Успешный ответ (`200`)**

  ```json
  { "ok": true }
  ```

  Любой ответ, отличный от `200`, следует считать признаком сбоя.

---

За дополнительной архитектурной информацией см. `docs/project_passport.md`. Перед добавлением новых эндпоинтов или изменением контрактов запрос/ответ связывайтесь с backend-командой.
