# Технический паспорт проекта Hermes

## Общее описание

**Hermes** - это система видеозвонков на базе WebRTC с поддержкой P2P соединений через TURN/STUN серверы. Проект представляет собой микросервисную архитектуру, развернутую в Docker контейнерах.

## Архитектура системы

### Компоненты системы

1. **API сервер** (`api/`) - REST API для управления звонками
2. **Signal сервер** (`signal/`) - WebSocket сервер для обмена сигналами WebRTC
3. **Caddy** (`caddy/`) - HTTP/HTTPS прокси и веб-сервер
4. **CoTURN** (`coturn/`) - TURN/STUN сервер для NAT traversal
5. **Redis** (`redis/`) - кэш и хранилище состояний
6. **Logger** (`logger/`) - система логирования звонков
7. **Web клиент** (`web/`) - фронтенд приложение

### Схема взаимодействия

```
[Web Client] <-> [Caddy] <-> [API/Signal] <-> [Redis]
                           <-> [CoTURN] <-> [Logger]
```

## Детальное описание компонентов

### 1. API сервер (api/)

**Технологии:** Node.js, Express, Redis, JWT

**Основные функции:**
- Создание звонков с генерацией 6-символьных кодов
- Разрешение кодов в токены для присоединения
- Управление жизненным циклом звонков
- Rate limiting и защита от брутфорса

**Ключевые эндпоинты:**
- `POST /api/call/create` - создание нового звонка
- `POST /api/call/resolve` - разрешение кода в токен
- `POST /api/join` - получение параметров для присоединения

**Особенности:**
- JWT токены с TTL 24 часа для присоединения
- OTC коды живут 15 минут
- Анти-брутфорс защита: 40 попыток с IP, 25 попыток с кода за 5 минут
- Базовый rate limit: 60 запросов в минуту с IP

### 2. Signal сервер (signal/)

**Технологии:** Node.js, WebSocket, Redis

**Основные функции:**
- WebSocket соединения для обмена WebRTC сигналами
- Управление участниками звонков (максимум 2)
- Пересылка сообщений между пирами
- Логирование событий звонков

**Протокол WebSocket:**
- Аутентификация через JWT токены
- Поддержка ролей: `offerer`, `answerer`, `observer`
- Автоматическое переподключение при разрыве соединения
- Ограничение: максимум 2 участника на звонок

### 3. CoTURN сервер (coturn/)

**Технологии:** CoTURN, TLS

**Конфигурация:**
- Порт 3478 (UDP/TCP) для STUN/TURN
- Порт 5349 (TLS) для TURNS
- Диапазон релейных портов: 49152-65535
- HMAC-SHA1 аутентификация с TTL 10 минут

**ICE серверы:**
- STUN: `stun:domain:3478`
- TURN UDP: `turn:domain:3478?transport=udp`
- TURN TCP: `turn:domain:3478?transport=tcp`
- TURNS: `turns:domain:5349?transport=tcp`

### 4. Web клиент (web/)

**Технологии:** Vanilla JavaScript, WebRTC, ES6 Modules

**Архитектура клиента:**
- `client.js` - основной файл инициализации
- `signaling-session.js` - управление WebSocket соединением
- `media-session.js` - управление WebRTC медиа
- `ui-controls.js` - управление интерфейсом
- `media-session.js` - обработка медиа потоков

**Функциональность:**
- Адаптивный дизайн (desktop/tablet/mobile)
- Управление камерой и микрофоном
- Копирование ссылки на звонок
- Таймер звонка
- Автоматическое переподключение

### 5. Redis (redis/)

**Использование:**
- Хранение состояний звонков
- Rate limiting счетчики
- OTC коды для присоединения
- Списки участников звонков
- Pub/Sub для логирования

**Структура ключей:**
- `call:{callId}` - данные звонка
- `call:{callId}:peers` - участники звонка
- `otc:{code}` - маппинг кода на callId
- `rl:ip:{ip}:*` - rate limiting по IP
- `rl:code:{hash}` - rate limiting по коду

### 6. Logger (logger/)

**Функции:**
- Подписка на Redis pub/sub каналы `logs:*`
- Цветное логирование в консоль
- Запись в файл `/var/log/calls/observer.log`
- Фильтрация по callId
- Детализированное логирование событий

## Безопасность

### Аутентификация
- JWT токены с HMAC-SHA256
- TTL токенов: 24 часа для присоединения, 10 минут для TURN
- Валидация подписей на всех уровнях

### Rate Limiting
- Базовый: 60 запросов/минуту с IP
- Анти-брутфорс: 40 попыток с IP, 25 с кода за 5 минут
- Graceful degradation при недоступности Redis

### CORS
- Разрешен только продакшн домен: `https://call.tgcall.us`
- Credentials отключены

## Конфигурация

### Переменные окружения

**Основные:**
- `SERVER_NAME` - домен сервера
- `JWT_SECRET` - секрет для JWT токенов
- `TURN_SECRET` - секрет для TURN аутентификации
- `REDIS_URL` - URL Redis сервера

**SSL:**
- `SSL_CERT_HOST_PATH` - путь к SSL сертификату
- `SSL_KEY_HOST_PATH` - путь к SSL ключу

**Логирование:**
- `LOGGER_CALL_FILTER` - фильтр по callId
- `LOGGER_INCLUDE_DETAIL` - включить детали в лог

## Жизненный цикл звонка

1. **Создание:** Пользователь создает звонок через API
2. **Генерация кода:** Создается 6-символьный код и JWT токен
3. **Присоединение:** Второй пользователь вводит код
4. **Разрешение:** Код обменивается на JWT токен
5. **WebSocket:** Участники подключаются к signal серверу
6. **WebRTC:** Устанавливается P2P соединение через TURN/STUN
7. **Медиа:** Обмен аудио/видео потоками
8. **Завершение:** Участники покидают звонок

## Особенности реализации

### WebRTC
- Использование `RTCPeerConnection` с ICE серверами
- Поддержка аудио и видео потоков
- Автоматическое переподключение при сбоях
- Graceful degradation при отказе в доступе к медиа

### Обработка ошибок
- Retry логика для WebSocket соединений
- Fallback при недоступности Redis
- Детальное логирование всех операций
- Graceful shutdown всех компонентов

### Производительность
- Connection pooling для Redis
- Эффективное использование WebSocket
- Минимальные задержки в сигналинге
- Оптимизированные ICE серверы

## Мониторинг и логирование

- Структурированные логи в JSON формате
- Цветное отображение в консоли
- Запись в файлы для анализа
- Метрики производительности WebRTC
- Отслеживание состояния соединений
